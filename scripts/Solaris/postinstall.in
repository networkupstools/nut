#!/bin/sh

#Postinstall script

NUT_DIR="@prefix@"

# make sure the nut user exists and has correct memberships
res="`getent group @RUN_AS_GROUP@`" || res=""
if [ -z "$res" ]; then
	/usr/sbin/groupadd "@RUN_AS_GROUP@"
fi
res="`getent passwd @RUN_AS_USER@`" || res=""
if [ -z "$res" ]; then
	/usr/sbin/useradd -c "Network UPS Tools" -g "@RUN_AS_GROUP@" -G root -d "@STATEPATH@" -s /bin/false @RUN_AS_USER@
fi

res="`groups "@RUN_AS_GROUP@" | grep -w "@RUN_AS_USER@"`" || res=""
if [ -z "$res" ]; then
	/usr/sbin/usermod -g "@RUN_AS_GROUP@" -G root "@RUN_AS_USER@"
fi

# make sure that conffiles are secured and have the correct ownerships
if [ -d "@CONFPATH@" ] ; then
	chown "root:@RUN_AS_GROUP@" "@CONFPATH@"
fi
for file in nut.conf ups.conf upsd.conf upsmon.conf upsd.users upssched.conf nut-driver-enumerator.conf; do
	if [ -f "@CONFPATH@/$file" ] ; then
		chown "root:@RUN_AS_GROUP@" "@CONFPATH@/$file"
		chmod 640 "@CONFPATH@/$file"
	fi
done

# make sure that /var/run/nut exists and has the correct ownerships
if [ ! -d "@PIDPATH@/nut" ] ; then
	mkdir -p "@PIDPATH@/nut"
fi
if [ -d "@PIDPATH@/nut" ] ; then
	chown "root:@RUN_AS_GROUP@" "@PIDPATH@/nut"
	chmod 770 "@PIDPATH@/nut"
fi

# make sure that /var/state/ups exists and has the correct ownerships
if [ ! -d "@STATEPATH@" ] ; then
	mkdir -p "@STATEPATH@"
fi
if [ -d "@STATEPATH@" ] ; then
	chown "root:@RUN_AS_GROUP@" "@STATEPATH@"
	chmod 770 "@STATEPATH@"
fi

if [ -n "@auglensdir@" ] && [ -d "@auglensdir@" ] && [ -d "@datadir@/augeas-lenses" ] ; then
	( cd "@datadir@/augeas-lenses" && cp -prf ./ "@auglensdir@"/ )
fi

# Put init script in /etc/init.d

cp -pf "@DATADIR@/solaris-init/nut" /etc/init.d
chown root:bin /etc/init.d/nut
chmod 744 /etc/init.d/nut

ln -s ../init.d/nut /etc/rc3.d/S90nut > /dev/null 2>&1
ln -s ../init.d/nut /etc/rc3.d/K10nut > /dev/null 2>&1

# Start nut services

#echo "Starting nut services"
#$NUT_DIR/sbin/upsdrvctl start #> /dev/null 2>&1
#$NUT_DIR/sbin/upsd #> /dev/null 2>&1
#$NUT_DIR/sbin/upsmon #> /dev/null 2>&1
